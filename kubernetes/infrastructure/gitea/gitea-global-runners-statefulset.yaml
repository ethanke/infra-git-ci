apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gitea-global-runners
  namespace: gitea
spec:
  serviceName: gitea-global-runners
  replicas: 4
  selector:
    matchLabels:
      app: gitea-global-runners
  template:
    metadata:
      labels:
        app: gitea-global-runners
    spec:
      serviceAccountName: gitea-global-runners
      securityContext:
        fsGroup: 1000
      containers:
      - name: docker-daemon
        image: docker:27-dind
        securityContext:
          privileged: true
        env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
        command:
        - dockerd
        - --host=tcp://0.0.0.0:2375
        - --storage-driver=overlay2
        volumeMounts:
        - name: docker-data
          mountPath: /var/lib/docker
        - name: registry-creds
          mountPath: /root/.docker
          readOnly: true
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      - name: act-runner
        image: gitea/act_runner:latest
        imagePullPolicy: Always
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Docker to be ready..."
          until nc -zv localhost 2375 > /dev/null 2>&1; do
            sleep 1
          done
          echo "Docker is ready!"
          
          cd /data
          if [ ! -f .runner ]; then
            echo "Registering runner..."
            RUNNER_NAME="global-runner-$(hostname | awk -F'-' '{print $NF}')"
            
            act_runner register \
              --instance https://git.lum.tools \
              --token ${GITEA_RUNNER_REGISTRATION_TOKEN} \
              --name "$RUNNER_NAME" \
              --labels "ubuntu-latest:docker://catthehacker/ubuntu:act-latest,ubuntu-22.04:docker://catthehacker/ubuntu:act-22.04,ubuntu-20.04:docker://catthehacker/ubuntu:act-20.04" \
              --no-interactive
          fi
          
          echo "Starting runner daemon..."
          act_runner daemon
        env:
        - name: GITEA_INSTANCE_URL
          value: https://git.lum.tools
        - name: GITEA_RUNNER_REGISTRATION_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitea-global-runners-secret
              key: token
        - name: DOCKER_HOST
          value: tcp://localhost:2375
        volumeMounts:
        - name: runner-data
          mountPath: /data
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: registry-creds
        secret:
          secretName: registry-creds
          items:
          - key: .dockerconfigjson
            path: config.json
  volumeClaimTemplates:
  - metadata:
      name: docker-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 50Gi
  - metadata:
      name: runner-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 2Gi
