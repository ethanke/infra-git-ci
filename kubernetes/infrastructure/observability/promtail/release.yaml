# Promtail - Log Collection Agent
# Collects logs from all pods and ships to Loki
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: promtail
  namespace: observability
spec:
  interval: 30m
  chart:
    spec:
      chart: promtail
      version: "6.*"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  values:
    # Disable ServiceMonitor (Prometheus Operator not installed)
    serviceMonitor:
      enabled: false
    
    # Loki endpoint
    config:
      clients:
        - url: http://loki-gateway.observability:80/loki/api/v1/push
          tenant_id: default
      
      # Positions file
      positions:
        filename: /run/promtail/positions.yaml
      
      # Scrape configs
      scrapeConfigs:
        # Kubernetes pods
        - job_name: kubernetes-pods
          kubernetes_sd_configs:
            - role: pod
          pipeline_stages:
            # Parse JSON logs (standard for lum.tools services)
            - match:
                selector: '{app=~".+"}'
                stages:
                  - json:
                      expressions:
                        level: level
                        message: message
                        timestamp: timestamp
                        service: service
                        trace_id: trace_id
                        span_id: span_id
                        error: exception.type
                  - labels:
                      level:
                      service:
                      error:
                  - timestamp:
                      source: timestamp
                      format: RFC3339Nano
            # Drop debug logs in production
            - match:
                selector: '{level="DEBUG"}'
                action: drop
          relabel_configs:
            # Keep namespace label
            - source_labels: [__meta_kubernetes_namespace]
              target_label: namespace
            # Keep pod name
            - source_labels: [__meta_kubernetes_pod_name]
              target_label: pod
            # Keep container name
            - source_labels: [__meta_kubernetes_pod_container_name]
              target_label: container
            # Use app label if available
            - source_labels: [__meta_kubernetes_pod_label_app]
              target_label: app
            # Add node name
            - source_labels: [__meta_kubernetes_pod_node_name]
              target_label: node
            # Drop kube-system namespace (optional, remove if needed)
            # - source_labels: [__meta_kubernetes_namespace]
            #   regex: kube-system
            #   action: drop
        
        # System journal logs
        - job_name: journal
          journal:
            max_age: 12h
            path: /var/log/journal
            labels:
              job: journal
          relabel_configs:
            - source_labels: [__journal__systemd_unit]
              target_label: unit
            - source_labels: [__journal__hostname]
              target_label: hostname
    
    # Resources
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
    
    # Run as DaemonSet on all nodes
    daemonSet:
      enabled: true
    
    # Tolerations to run on all nodes
    tolerations:
      - effect: NoSchedule
        operator: Exists
      - effect: NoExecute
        operator: Exists
    
    # Volume mounts for log access
    extraVolumes:
      - name: journal
        hostPath:
          path: /var/log/journal
      - name: machine-id
        hostPath:
          path: /etc/machine-id
    
    extraVolumeMounts:
      - name: journal
        mountPath: /var/log/journal
        readOnly: true
      - name: machine-id
        mountPath: /etc/machine-id
        readOnly: true
